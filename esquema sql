/* --- 1. ESTRUTURA ORGANIZACIONAL --- */

CREATE TABLE stores (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    erp_cost_center_id VARCHAR(50), -- Link com ERPNext (Centro de Custo)
    address JSONB, -- Endereço completo
    settings JSONB, -- Configs locais (ex: "allow_offline": true)
    created_at TIMESTAMP DEFAULT NOW()
);

CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    full_name VARCHAR(100),
    cpf VARCHAR(14) UNIQUE,
    birth_date DATE, -- Para validação +18
    face_vector BYTEA, -- Vetor biométrico (hash) para sync com Control iD
    status VARCHAR(20) DEFAULT 'ACTIVE', -- ACTIVE, BLOCKED, REVIEW
    loyalty_tier VARCHAR(20) DEFAULT 'STANDARD' -- STANDARD, VIP, WHALE
);

/* --- 2. PRODUTOS & ESTOQUE INTELIGENTE --- */

CREATE TABLE products (
    sku VARCHAR(50) PRIMARY KEY, -- Mesmo SKU do ERPNext
    name VARCHAR(150),
    base_price DECIMAL(10,2),
    image_url VARCHAR(255),
    category VARCHAR(50)
);

-- Mix de Produtos e Política de Estoque por Loja
CREATE TABLE store_products (
    store_id INT REFERENCES stores(id),
    product_sku VARCHAR(50) REFERENCES products(sku),
    current_price DECIMAL(10,2), -- Preço base + Delta da loja
    
    -- Lógica de Reposição
    min_stock_level INT, -- Ponto de pedido
    ideal_stock_level INT, -- Capacidade da gôndola
    stock_quantity INT, -- Estoque Lógico (Sincronizado)
    
    is_active BOOLEAN DEFAULT TRUE,
    PRIMARY KEY (store_id, product_sku)
);

/* --- 3. MOTOR DE PROMOÇÕES & REGRAS --- */

CREATE TABLE promotions (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100), -- "Promoção Verão", "Win-Back Cliente Sumido"
    trigger_type VARCHAR(50), -- 'CART_TOTAL', 'PRODUCT_BUNDLE', 'USER_INACTIVE'
    conditions JSONB, -- Ex: {"min_cart": 50, "target_category": "BEBIDAS"}
    actions JSONB, -- Ex: {"discount_percent": 10, "send_whatsapp": true}
    start_date TIMESTAMP,
    end_date TIMESTAMP,
    target_store_ids INT[] -- Lista de lojas participantes (NULL = todas)
);

/* --- 4. IOT & TELEMETRIA (Hardware) --- */

CREATE TABLE iot_devices (
    id SERIAL PRIMARY KEY,
    store_id INT REFERENCES stores(id),
    name VARCHAR(50), -- "Geladeira Cerveja", "Sensor Porta Entrada"
    device_type VARCHAR(30), -- 'LOCK_18', 'SENSOR_PRESENCE', 'CAMERA_RTSP'
    topic_mqtt VARCHAR(100),
    zone_security_level VARCHAR(20) -- 'PUBLIC', 'RESTRICTED'
);

-- Log inteligente (Sessões, não raw data)
CREATE TABLE telemetry_sessions (
    id BIGSERIAL PRIMARY KEY,
    store_id INT,
    device_id INT,
    session_start TIMESTAMP,
    session_end TIMESTAMP,
    duration_seconds INT,
    metadata JSONB -- Ex: {"event": "door_open_too_long", "count": 1}
);

/* --- 5. AUDITORIA & INTEGRAÇÃO --- */

CREATE TABLE audit_logs (
    id BIGSERIAL PRIMARY KEY,
    store_id INT,
    event_type VARCHAR(50), -- 'ACCESS_GRANTED', 'ACCESS_DENIED', 'SUSPICIOUS_ACTIVITY'
    description TEXT,
    video_timestamp TIMESTAMP, -- Para Deep Link na Intelbras
    severity_level INT -- 1 (Info) a 5 (Crítico)
);